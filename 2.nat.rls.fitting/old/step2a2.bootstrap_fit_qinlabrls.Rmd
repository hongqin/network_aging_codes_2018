---
title: "Fit Qin-lab natural isolates using bootstraps, Fixed R-fitting"
author: "h qin"
date: "2017 April 24 - June 11, Sep20-"
output:
  html_document: default
  pdf_document: default
---


```{r}
rm(list=ls())
host = "Applejack" #"Ridgeside"
if (host == "AppleJack") {
 setwd("/Users/hqin/github/bmc_netwk_aging_manuscript/R1/0.nat.rls.fitting");
}
if (host == "Ridgeside") {
 setwd("/home/hqin/github/bmc_netwk_aging_manuscript/R1/0.nat.rls.fitting");
}

library('flexsurv')
source("lifespan.r")
```

Set seed for consistency for publication purpose.  
```{r}
set.seed(20170101)  #remove to test for different bootstraps

llh.binomialMortality.single.run.NoR0 <- function( Rt0n, lifespan, debug=0 ) {
  I = R0;
  t0 = Rt0n[2]; n=Rt0n[3];
  my.data = lifespan[!is.na(lifespan)];
  log_s = (I * t0 /n )*(1 - (1 + my.data/t0)^n);
  log_m = log(I) +  (n-1) * log(1 + my.data/t0 ); 
  my.lh = sum(log_s)  + sum(log_m);
  if(debug) { print (c(I, Rt0n )); } #trace the convergence
  ret = - my.lh # because optim seems to maximize 
}
```

# parse the strains from files

```{r}
RUNS = 100; #bootstrap runs
#files = list.files(path="../qinlab_rls/", pattern="rls.tab")
#tmp1 = gsub("\\d{6}.", "", files)
#redundant_strains = gsub(".rls.tab", "", tmp1)
##strains = sort( unique( redundant_strains ))
#strains
```

# Take files from natural isolates
```{r}
my.strains=c("101S", "M1-2","M13","M14","M2-8","M22","M32","M34","M5","M8","RM112N","S288c","SGU57", "YPS128","YPS163")
#files2=c();
#for( i in 1:length(my.strains)){
# files2 = c( files2, files[grep(my.strains[i], files)]);
#}

report = data.frame(cbind(my.strains))
report$samplesize = NA; report$R=NA; report$t0=NA; report$n=NA; report$G=NA; report$longfilename=NA; 

#files = files2; 
#strains = my.strains; 
```


# Now, fit all RLS data sets by strains

```{r, message=FALSE }
for( BootstrapCount in 1:RUNS ) {#!!!!!!

for( i in 1:length(report[,1])){
#for( i in 3:4){
  #my.files = files[grep(strains[i], files)]
  filename = paste("rls/", my.strains[i], ".csv", sep='' ); 
  report$longfilename[i] = filename; 
  tb = read.csv( filename, header= F)

  report$samplesize[i] = length(tb[,1])

  #boostrap 
  tb[,1] = sample(tb[,1], replace=TRUE); # BOOTSTRAP HERE
  
  GompFlex = flexsurvreg(formula = Surv(tb[,1]) ~ 1, dist = 'gompertz')
  WeibFlex = flexsurvreg(formula = Surv(tb[,1]) ~ 1, dist = 'weibull')

  report$avgLS[i] =  mean(tb[,1])
  report$stdLS[i] =  sd(tb[,1])
  report$CV[i] = report$stdLS[i] / report$avgLS[i]

  report$GompGFlex[i] = GompFlex$res[1,1]
  report$GompRFlex[i] = GompFlex$res[2,1]
  report$GompLogLikFlex[i] = round(GompFlex$loglik, 1)
  report$GompAICFlex[i] = round(GompFlex$AIC)

  report$WeibShapeFlex[i] = WeibFlex$res[1,1]
  report$WeibRateFlex[i] = WeibFlex$res[2,1]
  report$WeibLogLikFlex[i] = round(WeibFlex$loglik, 1)  
  report$WeibAICFlex[i] = round(WeibFlex$AIC)

  #set initial values
  Rhat = report$GompRFlex[i]; # 'i' was missing. a bug costed HQ a whole afternoon.
  Ghat = report$GompGFlex[i];
  nhat = 6;  
  t0= (nhat-1)/Ghat;
  
  R0 = Rhat; 
  fitBinom = optim ( c(Rhat, t0, nhat),  llh.binomialMortality.single.run.NoR0, 
                     lifespan=tb[,1], 
                     #method='SANN') #SANN needs control  
                     method="L-BFGS-B", 
                     lower=c(1E-3, 1, 2), upper=c(0.1,200,100) );  
  report[i, c("R", "t0", "n")] = c( R0, fitBinom$par[2:3])
  report$G[i] = (report$n[i] - 1)/report$t0[i]

  #fitBinom = optim ( c(Rhat, t0, nhat),  llh.binomialMortality.single.run, 
  #                   lifespan=tb[,1], 
  #                   #method='SANN') #SANN needs control  
  #                   method="L-BFGS-B", 
  #                   lower=c(1E-10, 1, 4), upper=c(1,200,20) );  
  #report[i, c("R", "t0", "n")] = fitBinom$par[1:3]
  #report$G[i] = (report$n[i] - 1)/report$t0[i]
}#i loop

report$BestModel = ifelse(report$GompAICFlex < report$WeibAICFlex, "Gomp", "Weib")
report$BestModel = ifelse(abs(report$GompAICFlex - report$WeibAICFlex)<2, "<2", report$BestModel)
outname = paste("bootstrap/", BootstrapCount, ".csv", sep='');
write.csv(report, file = outname, row.names = FALSE);
}#end of boostrap loop

```

#summarize boostrap results. 
Pick row-col value from every file into a buffer, then mean and stddev. 

```{r}
BootstrapMean = report; 
BootstrapStd = report;
rownames = names(report);
for( col in 2:length(report[1,])) {
  for ( row in 1:length(report[,1])) {
    buffer = c();
    for( BootstrapCount in 1:RUNS ) {
      filename = paste("bootstrap/", BootstrapCount, ".csv", sep='');
      tb = read.csv(filename)
      if( rownames[col] == "BestModel" ) {
        buffer = as.character( c(buffer, as.character(tb[row,col])) );
      } else {
        buffer = c(buffer, tb[row, col]); 
      }
    }
    if( rownames[col] == "BestModel" ) {
      tmp = table( buffer );
      BootstrapMean[row,col] = paste(names(tmp), tmp, sep="=", collapse = ":");
    } else {
     BootstrapMean[row,col] = mean(buffer);
     BootstrapStd[row,col] = sqrt(var(buffer));
    }
  }  
}

```

Means 
```{r}
BootstrapMean
```


```{r}
summary(BootstrapMean$n)
```

StdDev
```{r}
BootstrapStd
```

Merge the two tables
```{r}
BootstrapMean$Rstd = BootstrapStd$R
BootstrapMean$t0std = BootstrapStd$t0
BootstrapMean$nstd = BootstrapStd$n
BootstrapMean$Gstd = BootstrapStd$G
BootstrapMean$avgLSstd = BootstrapStd$avgLS
names(BootstrapMean)
```

Reorganized the columns
```{r}
BootstrapMean = BootstrapMean[, c( "my.strains",  "samplesize",  "R", "Rstd",  "t0",  "t0std",  "n",  "nstd",   "G",  
                                   "Gstd", "avgLS",  "avgLSstd", "stdLS",   "BestModel",  
                                   "longfilename",   "CV",  "GompGFlex",  "GompRFlex",  "GompLogLikFlex", 
 "GompAICFlex",  "WeibShapeFlex",  "WeibRateFlex",  "WeibLogLikFlex",  "WeibAICFlex"  )];
BootstrapMean
```

Merge mean and std for publication
```{r}
BootstrapMeanPublishing = data.frame( BootstrapMean[, c("my.strains")] )
BootstrapMeanPublishing$RwithStd = as.vector( paste(round(BootstrapMean$R, 4), round(BootstrapMean$Rstd,4), sep=" +/- ") );
BootstrapMeanPublishing$t0withStd = as.vector( paste(round(BootstrapMean$t0, 1), round(BootstrapMean$t0std,1), sep=" +/- ") );
BootstrapMeanPublishing$nwithStd = as.vector( paste(round(BootstrapMean$n, 1), round(BootstrapMean$nstd,3), sep=" +/- ") );
BootstrapMeanPublishing$GwithStd = as.vector( paste(round(BootstrapMean$G, 2), round(BootstrapMean$Gstd,3), sep=" +/- ") );
BootstrapMeanPublishing$avgLSwithStd = as.vector( paste(round(BootstrapMean$avgLS, 2), round(BootstrapMean$avgLSstd,3), sep=" +/- ") );

BootstrapMeanPublishing
```

output
```{r}
write.csv(BootstrapMean, file="sandbox/Bootstrap_summary_fixedR0.csv", row.names = FALSE)
write.csv(BootstrapMeanPublishing, file="sandbox/Bootstrap_summary_for_publication_fixedR0.csv", row.names = FALSE)

```

Calculate lambda based on t0 = (1-p)/(p Lambda)
So, 1/lambda = t0 * p / (1-p)

```{r}
p = 0.7
BootstrapMean$One.over.lambdaP07 = BootstrapMean$t0 * p/ (1-p)
BootstrapMean[, c("t0", "One.over.lambdaP07")]
```

Histogram of 1/lambda for p=0.7
```{r}
hist(BootstrapMean$One.over.lambdaP07, br=20, xlim=c(60,190), xlab=expression(paste("1/",lambda) ), main=expression(paste("Histogram of 1/",lambda, " when p=0.7")))
```

```{r}
p = 0.9
BootstrapMean$One.over.lambdaP09 = BootstrapMean$t0 * p/ (1-p)
BootstrapMean[, c("t0", "One.over.lambdaP09")]
```

Histogram 1/lambda, p=0.9
```{r}
hist(BootstrapMean$One.over.lambdaP09, br=20, xlim=c(200,800), xlab=expression(paste("1/",lambda) ), main=expression(paste("Histogram of 1/",lambda, " when p=0.9")))
```
# Strehler-Mildvan correlation in using bootstrap results
```{r}
# BootstrapMean
summary(lm(log10(BootstrapMean$GompRFlex) ~ BootstrapMean$GompGFlex))
summary(lm(log10(BootstrapMean$R) ~ BootstrapMean$GompGFlex))
summary(lm(log10(BootstrapMean$R) ~ BootstrapMean$G)) #G from t0 and n 
summary(lm(log10(BootstrapMean$GompGFlex) ~ BootstrapMean$t0)) #G from t0 and n 
summary(lm(log10(BootstrapMean$R) ~ BootstrapMean$n)) #G from t0 and n 
```

# Does t0 mediate GFlex ~ log(RFlex)? Yes. 
```{r}
summary(lm( BootstrapMean$GompGFlex ~ BootstrapMean$t0 ))
summary(lm(log10(BootstrapMean$GompRFlex) ~ BootstrapMean$t0 ))
summary(lm(log10(BootstrapMean$GompRFlex) ~ BootstrapMean$GompGFlex ))

summary(lm(log10(BootstrapMean$GompGFlex) ~ BootstrapMean$t0 + log10(BootstrapMean$GompRFlex)))
summary(lm(log10(BootstrapMean$GompRFlex) ~ BootstrapMean$t0 + log10(BootstrapMean$GompGFlex))) #not significant. 
```

# Why std of avgLS is so large of bootstrap ? This may indicate bootstrap or averaging process have bugs! 




